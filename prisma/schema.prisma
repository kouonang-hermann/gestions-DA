generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL")
}

model User {
  id                   String                @id @default(cuid())
  nom                  String
  prenom               String
  email                String?               @unique
  password             String
  role                 UserRole
  isAdmin              Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  phone                String                @unique @db.VarChar(20)
  demandesCreees       Demande[]             @relation("DemandeCreateur")
  demandesALivrer      Demande[]             @relation("DemandesALivrer")
  historyEntries       HistoryEntry[]
  notifications        Notification[]
  projetsCreated       Projet[]              @relation("ProjetCreateur")
  sortiesAppro         SortieSignature[]     @relation("SortieAppro")
  projets              UserProjet[]
  validationSignatures ValidationSignature[]

  @@map("users")
}

model Projet {
  id            String         @id @default(cuid())
  nom           String
  description   String
  dateDebut     DateTime
  dateFin       DateTime?
  actif         Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String
  budget        Float?         // Budget alloué au projet
  demandes      Demande[]
  notifications Notification[]
  createur      User           @relation("ProjetCreateur", fields: [createdBy], references: [id])
  utilisateurs  UserProjet[]

  @@map("projets")
}

model UserProjet {
  id       String @id @default(cuid())
  userId   String
  projetId String
  projet   Projet @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projetId])
  @@map("user_projets")
}

model Article {
  id           String        @id @default(cuid())
  nom          String
  description  String
  reference    String        @unique
  unite        String
  type         DemandeType
  stock        Int?
  prixUnitaire Float?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  itemsDemande ItemDemande[]

  @@map("articles")
}

model Demande {
  id                     String                @id @default(cuid())
  numero                 String                @unique
  projetId               String
  technicienId           String
  type                   DemandeType
  status                 DemandeStatus         @default(brouillon)
  dateCreation           DateTime              @default(now())
  dateModification       DateTime              @updatedAt
  dateSortie             DateTime?
  dateValidationFinale   DateTime?
  dateLivraisonSouhaitee DateTime?
  commentaires           String?
  rejetMotif             String?
  coutTotal              Float?                // Coût total de la demande (visible uniquement par superadmin)
  budgetPrevisionnel     Float?                // Budget prévisionnel saisi par le chargé d'affaires
  dateEngagement         DateTime?             // Date d'engagement financier (quand les prix sont validés)
  livreurAssigneId       String?               // ID de la personne assignée pour livrer
  dateReceptionLivreur   DateTime?             // Date de réception du matériel par le livreur
  dateLivraison          DateTime?             // Date de livraison au demandeur
  projet                 Projet                @relation(fields: [projetId], references: [id])
  technicien             User                  @relation("DemandeCreateur", fields: [technicienId], references: [id])
  livreurAssigne         User?                 @relation("DemandesALivrer", fields: [livreurAssigneId], references: [id])
  historyEntries         HistoryEntry[]
  items                  ItemDemande[]
  notifications          Notification[]
  sortieAppro            SortieSignature?      @relation("SortieAppro")
  validationSignatures   ValidationSignature[]

  @@map("demandes")
}

model ItemDemande {
  id               String  @id @default(cuid())
  demandeId        String
  articleId        String
  quantiteDemandee Int
  quantiteValidee  Int?
  quantiteSortie   Int?
  quantiteRecue    Int?
  commentaire      String?
  prixUnitaire     Float?  // Prix unitaire saisi par le responsable appro
  article          Article @relation(fields: [articleId], references: [id])
  demande          Demande @relation(fields: [demandeId], references: [id], onDelete: Cascade)

  @@map("item_demandes")
}

model ValidationSignature {
  id          String   @id @default(cuid())
  userId      String
  demandeId   String
  date        DateTime @default(now())
  commentaire String?
  signature   String
  type        String
  demande     Demande  @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@unique([demandeId, type])
  @@map("validation_signatures")
}

model SortieSignature {
  id                     String   @id @default(cuid())
  userId                 String
  demandeId              String   @unique
  date                   DateTime @default(now())
  commentaire            String?
  signature              String
  quantitesSorties       Json
  modifiable             Boolean  @default(true)
  dateModificationLimite DateTime
  demande                Demande  @relation("SortieAppro", fields: [demandeId], references: [id])
  user                   User     @relation("SortieAppro", fields: [userId], references: [id])

  @@map("sortie_signatures")
}

model HistoryEntry {
  id            String         @id @default(cuid())
  demandeId     String
  userId        String
  action        String
  ancienStatus  DemandeStatus?
  nouveauStatus DemandeStatus?
  commentaire   String?
  timestamp     DateTime       @default(now())
  signature     String
  demande       Demande        @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id])

  @@map("history_entries")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  titre     String
  message   String
  lu        Boolean  @default(false)
  createdAt DateTime @default(now())
  demandeId String?
  projetId  String?
  demande   Demande? @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  projet    Projet?  @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum UserRole {
  superadmin
  employe
  conducteur_travaux
  responsable_travaux
  responsable_logistique
  responsable_appro
  charge_affaire
  responsable_livreur
}

enum DemandeType {
  materiel
  outillage
}

enum DemandeStatus {
  brouillon
  soumise
  en_attente_validation_conducteur
  en_attente_validation_logistique
  en_attente_validation_responsable_travaux
  en_attente_validation_charge_affaire
  en_attente_preparation_appro
  en_attente_reception_livreur
  en_attente_livraison
  en_attente_validation_finale_demandeur
  confirmee_demandeur
  cloturee
  rejetee
  archivee
}
