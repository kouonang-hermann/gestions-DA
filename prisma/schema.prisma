generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL")
}

model Article {
  id            String          @id
  nom           String
  description   String
  reference     String?
  unite         String
  type          DemandeType
  stock         Int?
  prixUnitaire  Float?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  items         ItemDemande[]

  @@map("articles")
}

model Demande {
  id                     String                  @id
  numero                 String                  @unique
  projetId               String
  technicienId           String
  type                   DemandeType
  status                 DemandeStatus           @default(brouillon)
  dateCreation           DateTime                @default(now())
  dateModification       DateTime
  dateSortie             DateTime?
  dateValidationFinale   DateTime?
  dateLivraisonSouhaitee DateTime?
  commentaires           String?
  rejetMotif             String?
  coutTotal              Float?
  dateEngagement         DateTime?
  budgetPrevisionnel     Float?
  dateLivraison          DateTime?
  dateReceptionLivreur   DateTime?
  livreurAssigneId       String?
  nombreRejets           Int                     @default(0)
  statusPrecedent        DemandeStatus?
  fichiersJoints         String[]                @default([])
  livreurAssigne         User?                   @relation("demandes_livreurAssigneIdTousers", fields: [livreurAssigneId], references: [id])
  projet                 Projet                  @relation(fields: [projetId], references: [id], onDelete: Cascade)
  technicien             User                    @relation("demandes_technicienIdTousers", fields: [technicienId], references: [id])
  history                HistoryEntry[]
  items                  ItemDemande[]
  livraisons             Livraison[]
  notifications          Notification[]
  sortieSignature        SortieSignature?
  validationSignatures   ValidationSignature[]

  @@map("demandes")
}

model HistoryEntry {
  id            String         @id
  demandeId     String
  userId        String
  action        String
  ancienStatus  DemandeStatus?
  nouveauStatus DemandeStatus?
  commentaire   String?
  timestamp     DateTime       @default(now())
  signature     String
  demande       Demande        @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id])

  @@map("history_entries")
}

model ItemDemande {
  id               String            @id
  demandeId        String
  articleId        String
  quantiteDemandee Int
  quantiteValidee  Int?
  quantiteSortie   Int?
  quantiteRecue    Int?
  commentaire      String?
  prixUnitaire     Float?
  article          Article           @relation(fields: [articleId], references: [id])
  demande          Demande           @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  livraisons       ItemLivraison[]

  @@map("item_demandes")
}

model ItemLivraison {
  id             String        @id
  livraisonId    String
  itemDemandeId  String
  quantiteLivree Int
  itemDemande    ItemDemande   @relation(fields: [itemDemandeId], references: [id], onDelete: Cascade)
  livraison      Livraison     @relation(fields: [livraisonId], references: [id], onDelete: Cascade)

  @@map("item_livraisons")
}

model Livraison {
  id              String            @id
  demandeId       String
  livreurId       String
  dateCreation    DateTime          @default(now())
  dateLivraison   DateTime?
  commentaire     String?
  statut          LivraisonStatut   @default(en_preparation)
  items           ItemLivraison[]
  demande         Demande           @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  livreur         User              @relation(fields: [livreurId], references: [id])

  @@map("livraisons")
}

model Notification {
  id        String    @id
  userId    String
  titre     String
  message   String
  lu        Boolean   @default(false)
  createdAt DateTime  @default(now())
  demandeId String?
  projetId  String?
  demande   Demande?  @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  projet    Projet?   @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Projet {
  id            String          @id
  nom           String
  description   String
  dateDebut     DateTime
  dateFin       DateTime?
  actif         Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  createdBy     String
  budget        Float?
  demandes      Demande[]
  notifications Notification[]
  createdByUser User            @relation(fields: [createdBy], references: [id])
  utilisateurs  UserProjet[]

  @@map("projets")
}

model SortieSignature {
  id                     String   @id
  userId                 String
  demandeId              String   @unique
  date                   DateTime @default(now())
  commentaire            String?
  signature              String
  quantitesSorties       Json
  modifiable             Boolean  @default(true)
  dateModificationLimite DateTime
  demande                Demande  @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  user                   User     @relation(fields: [userId], references: [id])

  @@map("sortie_signatures")
}

model UserProjet {
  id       String  @id
  userId   String
  projetId String
  projet   Projet  @relation(fields: [projetId], references: [id], onDelete: Cascade)
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projetId])
  @@map("user_projets")
}

model User {
  id                      String                  @id
  nom                     String
  prenom                  String
  email                   String?                 @unique
  password                String
  role                    UserRole
  isAdmin                 Boolean                 @default(false)
  createdAt               DateTime                @default(now())
  updatedAt               DateTime
  phone                   String                  @unique @db.VarChar(20)
  demandesLivreur         Demande[]               @relation("demandes_livreurAssigneIdTousers")
  demandesTechnicien      Demande[]               @relation("demandes_technicienIdTousers")
  historyEntries          HistoryEntry[]
  livraisons              Livraison[]
  notifications           Notification[]
  projetsCreated          Projet[]
  sortieSignatures        SortieSignature[]
  projets                 UserProjet[]
  validationSignatures    ValidationSignature[]

  @@map("users")
}

model ValidationSignature {
  id          String   @id
  userId      String
  demandeId   String
  date        DateTime @default(now())
  commentaire String?
  signature   String
  type        String
  demande     Demande  @relation(fields: [demandeId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@unique([demandeId, type])
  @@map("validation_signatures")
}

enum DemandeStatus {
  brouillon
  soumise
  en_attente_validation_conducteur
  en_attente_validation_logistique
  en_attente_validation_responsable_travaux
  en_attente_validation_charge_affaire
  en_attente_preparation_appro
  en_attente_reception_livreur
  en_attente_livraison
  en_attente_validation_finale_demandeur
  confirmee_demandeur
  cloturee
  rejetee
  archivee
  en_attente_validation_logistique_finale
  en_attente_preparation_logistique
}

enum DemandeType {
  materiel
  outillage
}

enum LivraisonStatut {
  en_preparation
  prete
  en_cours
  livree
  annulee
}

enum UserRole {
  superadmin
  employe
  conducteur_travaux
  responsable_travaux
  responsable_logistique
  responsable_appro
  charge_affaire
  responsable_livreur
}
