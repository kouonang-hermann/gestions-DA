/**
 * Test sp√©cifique du flow QHSE pour les demandes d'outillage
 * Flow: Demandeur ‚Üí QHSE ‚Üí Appro ‚Üí Charg√© Affaire ‚Üí Logistique ‚Üí Confirmation Demandeur
 */

const API_BASE = 'http://localhost:3000/api'

const testUsers = {
  demandeur: { email: 'employe@test.com', password: 'employe123', role: 'employe' },
  qhse: { email: 'qhse@test.com', password: 'qhse123', role: 'responsable_qhse' },
  appro: { email: 'appro@test.com', password: 'appro123', role: 'responsable_appro' },
  chargeAffaire: { email: 'charge@test.com', password: 'charge123', role: 'charge_affaire' },
  logistique: { email: 'logistique@test.com', password: 'logistique123', role: 'responsable_logistique' }
}

let tokens = {}
let demandeId = null
let itemIds = []

async function login(userType) {
  const user = testUsers[userType]
  console.log(`\nüîê Connexion ${userType} (${user.email})...`)
  
  try {
    const response = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: user.email, password: user.password })
    })
    
    const result = await response.json()
    if (result.success) {
      tokens[userType] = result.data.token
      console.log(`‚úÖ ${userType} connect√©`)
      return result.data.token
    } else {
      console.error(`‚ùå Connexion √©chou√©e pour ${userType}:`, result.error)
      return null
    }
  } catch (error) {
    console.error(`‚ùå Erreur r√©seau pour ${userType}:`, error.message)
    return null
  }
}

async function createOutillageRequest() {
  console.log('\nüìù Cr√©ation demande OUTILLAGE par employ√©...')
  
  const demandeData = {
    projetId: 'projet-test-1',
    type: 'outillage',
    justification: 'Test flow QHSE pour outillage avec modifications',
    urgence: false,
    items: [
      {
        nom: 'Perceuse √©lectrique',
        reference: 'PER-001',
        description: 'Perceuse 18V avec batterie',
        quantite: 3,
        unite: 'pi√®ce'
      },
      {
        nom: 'Scie circulaire',
        reference: 'SCI-002', 
        description: 'Scie circulaire 190mm',
        quantite: 2,
        unite: 'pi√®ce'
      }
    ]
  }
  
  try {
    const response = await fetch(`${API_BASE}/demandes`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${tokens.demandeur}`
      },
      body: JSON.stringify(demandeData)
    })
    
    const result = await response.json()
    if (result.success) {
      demandeId = result.data.id
      itemIds = result.data.items?.map(item => item.id) || []
      console.log(`‚úÖ Demande outillage cr√©√©e: ${demandeId}`)
      console.log(`   Statut: ${result.data.status}`)
      console.log(`   Items: ${itemIds.length}`)
      return result.data
    } else {
      console.error('‚ùå Cr√©ation √©chou√©e:', result.error)
      return null
    }
  } catch (error) {
    console.error('‚ùå Erreur cr√©ation:', error.message)
    return null
  }
}

async function validateWithModifications(userType, expectedStatus, nextStatus, modifications = {}) {
  console.log(`\nüîç Validation par ${userType}...`)
  
  try {
    // V√©rifier statut actuel
    const getResponse = await fetch(`${API_BASE}/demandes/${demandeId}`, {
      headers: { 'Authorization': `Bearer ${tokens[userType]}` }
    })
    
    const demande = await getResponse.json()
    if (!demande.success) {
      console.error(`‚ùå Impossible de r√©cup√©rer demande:`, demande.error)
      return false
    }
    
    console.log(`   Statut actuel: ${demande.data.status}`)
    if (demande.data.status !== expectedStatus) {
      console.error(`‚ùå Statut incorrect! Attendu: ${expectedStatus}`)
      return false
    }
    
    // Pr√©parer donn√©es de validation avec modifications
    const validationData = {
      action: 'valider',
      commentaire: `Validation ${userType} avec modifications outillage`,
      ...modifications
    }
    
    const response = await fetch(`${API_BASE}/demandes/${demandeId}/actions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${tokens[userType]}`
      },
      body: JSON.stringify(validationData)
    })
    
    const result = await response.json()
    if (result.success) {
      console.log(`‚úÖ Validation r√©ussie par ${userType}`)
      console.log(`   Nouveau statut: ${result.data.demande.status}`)
      
      if (result.data.demande.status === nextStatus) {
        return true
      } else {
        console.error(`‚ùå Statut incorrect! Attendu: ${nextStatus}, Actuel: ${result.data.demande.status}`)
        return false
      }
    } else {
      console.error(`‚ùå Validation √©chou√©e:`, result.error)
      return false
    }
  } catch (error) {
    console.error(`‚ùå Erreur validation ${userType}:`, error.message)
    return false
  }
}

async function runQHSEOutillageTest() {
  console.log('üöÄ TEST FLOW QHSE - DEMANDE OUTILLAGE')
  console.log('=' .repeat(50))
  
  try {
    // Connexions
    console.log('\nüìã √âTAPE 1: Connexions utilisateurs')
    for (const userType of Object.keys(testUsers)) {
      const token = await login(userType)
      if (!token) throw new Error(`Connexion √©chou√©e: ${userType}`)
    }
    
    // Cr√©ation demande outillage
    console.log('\nüìã √âTAPE 2: Cr√©ation demande OUTILLAGE')
    const demande = await createOutillageRequest()
    if (!demande) throw new Error('Cr√©ation demande outillage √©chou√©e')
    
    // V√©rifier que le statut initial est correct pour outillage
    if (demande.status !== 'en_attente_validation_qhse') {
      console.error(`‚ùå Statut initial incorrect pour outillage! Attendu: en_attente_validation_qhse, Actuel: ${demande.status}`)
      throw new Error('Statut initial incorrect')
    }
    console.log('‚úÖ Statut initial correct pour outillage: en_attente_validation_qhse')
    
    // Validation QHSE avec modifications (peut modifier nom, r√©f√©rence, quantit√©)
    console.log('\nüìã √âTAPE 3: Validation QHSE (peut modifier nom, r√©f√©rence, quantit√©)')
    const step3 = await validateWithModifications(
      'qhse',
      'en_attente_validation_qhse',
      'en_attente_validation_appro',
      {
        itemsModifications: itemIds.length > 0 ? {
          [itemIds[0]]: {
            nom: 'Perceuse √©lectrique CERTIFI√âE',
            reference: 'PER-001-CERT',
            quantite: 2,
            description: 'Perceuse 18V certifi√©e s√©curit√©'
          }
        } : {}
      }
    )
    if (!step3) throw new Error('√âtape 3 QHSE √©chou√©e')
    
    // Pr√©paration appro (seulement quantit√©s)
    console.log('\nüìã √âTAPE 4: Pr√©paration appro (peut seulement modifier quantit√©s)')
    try {
      const response = await fetch(`${API_BASE}/demandes/${demandeId}/actions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${tokens.appro}`
        },
        body: JSON.stringify({
          action: 'preparer_sortie',
          commentaire: 'Pr√©paration outillage avec ajustement stock',
          itemsModifications: itemIds.length > 0 ? {
            [itemIds[0]]: { quantite: 2 }
          } : {},
          quantitesSorties: itemIds.length > 0 ? {
            [itemIds[0]]: 2,
            [itemIds[1]]: 2
          } : {}
        })
      })
      
      const result = await response.json()
      if (!result.success) throw new Error('Pr√©paration appro √©chou√©e: ' + result.error)
      console.log('‚úÖ Pr√©paration appro r√©ussie')
    } catch (error) {
      console.error('‚ùå Erreur pr√©paration appro:', error.message)
      throw error
    }
    
    // Validation charg√© affaire
    console.log('\nüìã √âTAPE 5: Validation charg√© affaire (peut modifier nom, r√©f√©rence, quantit√©)')
    const step5 = await validateWithModifications(
      'chargeAffaire',
      'en_attente_validation_charge_affaire',
      'en_attente_validation_logistique',
      {
        itemsModifications: itemIds.length > 1 ? {
          [itemIds[1]]: {
            nom: 'Scie circulaire PROFESSIONNELLE',
            reference: 'SCI-002-PRO'
          }
        } : {}
      }
    )
    if (!step5) throw new Error('√âtape 5 √©chou√©e')
    
    // Validation logistique (seulement quantit√©s)
    console.log('\nüìã √âTAPE 6: Validation logistique (peut seulement modifier quantit√©s)')
    const step6 = await validateWithModifications(
      'logistique',
      'en_attente_validation_logistique',
      'en_attente_confirmation_demandeur',
      {
        itemsModifications: itemIds.length > 1 ? {
          [itemIds[1]]: { quantite: 1 }
        } : {}
      }
    )
    if (!step6) throw new Error('√âtape 6 √©chou√©e')
    
    // Confirmation finale demandeur
    console.log('\nüìã √âTAPE 7: Confirmation finale demandeur')
    try {
      const response = await fetch(`${API_BASE}/demandes/${demandeId}/actions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${tokens.demandeur}`
        },
        body: JSON.stringify({
          action: 'confirmer',
          commentaire: 'Demande outillage confirm√©e et cl√¥tur√©e'
        })
      })
      
      const result = await response.json()
      if (!result.success) throw new Error('Confirmation √©chou√©e: ' + result.error)
      
      if (result.data.demande.status === 'confirmee_demandeur') {
        console.log('‚úÖ Demande outillage confirm√©e et cl√¥tur√©e')
      } else {
        throw new Error(`Statut final incorrect: ${result.data.demande.status}`)
      }
    } catch (error) {
      console.error('‚ùå Erreur confirmation:', error.message)
      throw error
    }
    
    console.log('\nüéâ TEST QHSE OUTILLAGE R√âUSSI!')
    console.log('=' .repeat(50))
    console.log('‚úÖ Flow QHSE pour outillage enti√®rement fonctionnel')
    console.log('‚úÖ QHSE peut modifier nom, r√©f√©rence, quantit√© et description')
    console.log('‚úÖ Statut initial correct pour type outillage (en_attente_validation_qhse)')
    console.log('‚úÖ Transitions de statuts correctes')
    console.log(`‚úÖ Demande outillage ${demandeId} compl√®tement trait√©e`)
    
  } catch (error) {
    console.error('\nüí• √âCHEC DU TEST QHSE:', error.message)
    console.log('=' .repeat(50))
    
    // Diagnostic
    if (demandeId && tokens.demandeur) {
      try {
        const response = await fetch(`${API_BASE}/demandes/${demandeId}`, {
          headers: { 'Authorization': `Bearer ${tokens.demandeur}` }
        })
        const result = await response.json()
        if (result.success) {
          console.log(`üìä √âtat actuel: ${result.data.status}`)
        }
      } catch (e) {
        console.log('Impossible de r√©cup√©rer l\'√©tat de la demande')
      }
    }
  }
}

// Attendre que le serveur soit pr√™t puis ex√©cuter
setTimeout(() => {
  runQHSEOutillageTest().catch(console.error)
}, 2000)
